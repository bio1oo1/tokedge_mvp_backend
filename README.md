# Tok-Edge Access Backend

NestJS backend API for Tok-Edge Access - a gated referral and scoring experience for crypto investors.

## Tech Stack

- **Framework**: NestJS
- **Database**: Firebase Postgres via **Firebase Data Connect** (no direct PostgreSQL connection)
- **Firebase**: Firebase Admin SDK (Data Connect only; no Realtime Database)
- **Validation**: class-validator, class-transformer

## Setup

1. Install dependencies:

```bash
yarn install
```

1. Set up environment variables:

```bash
cp .env.example .env
# Edit .env: Firebase service account and Data Connect serviceId/location
```

1. **Firebase Data Connect** (Firebase Postgres):
  - Ensure you have a Firebase project with Data Connect enabled and a Postgres instance (Cloud SQL).
  - Update `dataconnect/dataconnect.yaml`: set `serviceId`, `location`, and `datasource.postgresql.cloudSql.instanceId`.
  - Deploy schema and connector:
  - **Generate the admin Node SDK** (required for real DB access; the app uses the generated SDK):
   This overwrites the stub in `src/dataconnect-generated/` with the real typed SDK. Until you run it, the app will build but Data Connect calls will throw at runtime.
2. Start development server:

```bash
yarn start:dev
```

---

## Local testing without Blaze (Data Connect emulator)

You can run the app fully locally using the **Data Connect emulator** (no Blaze plan or Cloud SQL needed).

1. **Install emulators** (one-time, if not already done):
  ```bash
   firebase init emulators
  ```
   Select **Data Connect** when prompted.
2. **Generate the SDK** (uses your schema + connector; works with emulator):
  ```bash
   firebase dataconnect:sdk:generate
  ```
3. **Use the emulator** in `.env`:
  ```bash
   DATA_CONNECT_EMULATOR_HOST=127.0.0.1:9399
  ```
   (This is already set in `.env.example` for local testing.)
4. **Start the Data Connect emulator** (in one terminal):
  ```bash
   yarn emulator:dataconnect
  ```
   Leave it running. It uses a local PGLite DB and serves on port 9399.
5. **Start the Nest app** (in another terminal):
  ```bash
   yarn start:dev
  ```

The Admin SDK will use the emulator automatically when `DATA_CONNECT_EMULATOR_HOST` is set. To test against production later, remove or comment out that variable and deploy with `firebase deploy --only dataconnect`.

## API Endpoints

### POST /api/wallet/analyze

Analyze a wallet address and return scoring results.

**Request Body:**

```json
{
  "walletAddress": "0x...",
  "inviteCode": "ABCDEFGH",
  "utm": { "source": "twitter", "medium": "social", "campaign": "kol1" },
  "clientMeta": { "userAgent": "...", "ip": "...", "gaClientId": "..." }
}
```

**Response:** `userId`, `rank`, `score`, `eligibility`, `metricsSummary`, `shareCardId`

### GET /api/wallet/portfolio?userId={userId}

Get portfolio snapshot for a user.

### GET /api/invite/{inviteCode}/stats

Get statistics for an invite code (Admin only).

## Project Structure

```
dataconnect/                 # Firebase Data Connect
├── dataconnect.yaml        # Service and schema config
├── schema/
│   └── schema.gql          # GraphQL schema (tables)
└── connector/
    ├── connector.yaml      # Connector + admin SDK generation
    ├── invite-codes.gql    # Queries/mutations for invite codes
    ├── users.gql
    ├── portfolio-snapshots.gql
    └── events.gql

src/
├── dataconnect-generated/  # Generated by firebase dataconnect:sdk:generate (stub until then)
├── config/
├── database/
│   ├── data-connect.service.ts   # Uses generated SDK from @tokedge/dataconnect-generated
│   └── database.module.ts
├── wallet/
├── invite/
├── app.module.ts
└── main.ts
```

## Environment Variables

See `.env.example`. Key variables:

- **Firebase**: `FIREBASE_PROJECT_ID`, `FIREBASE_PRIVATE_KEY`, `FIREBASE_CLIENT_EMAIL` (or use a service account JSON).
- **Data Connect**: `DATA_CONNECT_SERVICE_ID`, `DATA_CONNECT_LOCATION`, `DATA_CONNECT_CONNECTOR`.

## Notes

- All database access uses the **generated Data Connect SDK** (`@tokedge/dataconnect-generated`). Run `firebase dataconnect:sdk:generate` to generate it from the `.gql` operations in `dataconnect/connector/`. There is no direct PostgreSQL connection and no Realtime Database.
- Wallet addresses are normalized to lowercase and hashed for privacy.
- Invite codes are 8 characters, uppercase, A-Z excluding I and O.
- After changing `dataconnect/schema/*.gql` or connector, redeploy with `firebase deploy --only dataconnect` and optionally regenerate the SDK.

